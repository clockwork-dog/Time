
#include <TimeLib.h>

bool secondFire = false; // 1 second fire flag


void setup() {

  InternalRTC.attachInterrupt(rtc_irq, 1); // set user IRQ function fired by internal RTC clock 
                                           // (1Hz by defaut, max 8192Hz, only power of 2 number)
                                           // run only on megaAVR-0 series!
                                           // note : use InternalRTC.detachInterrupt() for detach IRQ function
                                           
  InternalRTC.setFreqPrecision(16);        // set the frequency of internal rtc cycles : 16Hz : 1/16 = 0.0625s
                                           // (1Hz by defaut, max 8192Hz, only power of 2 number)
                                           // run only on megaAVR-0 series!
                                           // note : use InternalRTC.getFreqPrecision() for get actual frequency
  
  setTime(8,15,00,24,04,1981);             // set the current system timestamp from arbitrary date/time
                                           // now... at +/- 0.0625s (depend of setFreqPrecision)

  Serial.begin(9600);                      // init serial
  pinMode(LED_BUILTIN, OUTPUT);            // init built-in led
  
}

void rtc_irq() { // executed all seconds
     
  secondFire = true; // fire flag
 
}

void loop() {

  if( secondFire ) { // make actions if flag is fired:

    secondFire = false; // unfire flag

    unsigned long actualTime = now(); // get actual system timestamp

    // display current system date and time:
    Serial.print(year(actualTime));
    Serial.print("-");
    Serial.print(month(actualTime));
    Serial.print("-");
    Serial.print(day(actualTime));
    Serial.print(" ");
    Serial.print(hour(actualTime));
    Serial.print(":");
    Serial.print(minute(actualTime));
    Serial.print(":");
    Serial.println(second(actualTime));

    // blink led:
    digitalWrite(LED_BUILTIN, HIGH);
    delay(50);
    digitalWrite(LED_BUILTIN, LOW);

  }

}
